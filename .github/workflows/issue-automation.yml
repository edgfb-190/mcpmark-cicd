name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create required labels if missing
        uses: actions/github-script@v7
        with:
          script: |
            const labelsToCreate = [
              // Category Labels
              { name: "bug", color: "d73a4a", description: "Something isn't working" },
              { name: "enhancement", color: "a2eeef", description: "New feature or request" },
              { name: "epic", color: "0052cc", description: "Large feature requiring multiple sub-tasks" },
              { name: "maintenance", color: "fef2c0", description: "Maintenance and housekeeping tasks" },
              
              // Priority Labels
              { name: "priority-critical", color: "b60205", description: "Critical priority issue" },
              { name: "priority-high", color: "d93f0b", description: "High priority issue" },
              { name: "priority-medium", color: "fbca04", description: "Medium priority issue" },
              { name: "priority-low", color: "0e8a16", description: "Low priority issue" },
              
              // Status Labels
              { name: "needs-triage", color: "f9d0c4", description: "Needs to be reviewed by maintainers" },
              { name: "needs-review", color: "bfdadc", description: "Awaiting review from maintainers" },
              { name: "first-time-contributor", color: "1d76db", description: "Issue created by first-time contributor" }
            ];

            for (const label of labelsToCreate) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (err) {
                if (err.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                } else {
                  throw err;
                }
              }
            }

      - name: Triage issue (assign category/priority labels)
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : "";
            const currentLabels = issue.labels.map(l => l.name);

            // Add initial "needs-triage" label if missing
            if (!currentLabels.includes("needs-triage")) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ["needs-triage"]
              });
            }

            // Assign category labels based on title keywords
            const categoryMap = {
              "bug": title.includes("bug"),
              "epic": title.includes("epic"),
              "maintenance": title.includes("maintenance")
            };

            for (const [label, shouldAdd] of Object.entries(categoryMap)) {
              if (shouldAdd && !currentLabels.includes(label)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: [label]
                });
              }
            }

            // Assign priority labels (highest priority wins)
            const priorityRules = [
              { label: "priority-critical", keywords: ["critical", "urgent", "production", "outage"] },
              { label: "priority-high", keywords: ["important", "high", "blocking"] },
              { label: "priority-medium", keywords: ["medium", "normal"] },
              { label: "priority-low", keywords: ["low", "nice-to-have", "minor"] }
            ];

            let assignedPriority = null;
            for (const rule of priorityRules) {
              const hasKeyword = rule.keywords.some(k => title.includes(k) || body.includes(k));
              if (hasKeyword) {
                assignedPriority = rule.label;
                break;
              }
            }

            // Default to medium if no priority found
            assignedPriority = assignedPriority || "priority-medium";

            // Remove existing priority labels before adding new one
            const existingPriorityLabels = currentLabels.filter(l => l.startsWith("priority-"));
            if (existingPriorityLabels.length > 0) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: existingPriorityLabels
              });
            }

            // Add the correct priority label
            if (!currentLabels.includes(assignedPriority)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [assignedPriority]
              });
            }

  task-breakdown:
    runs-on: ubuntu-latest
    needs: issue-triage
    if: contains(github.event.issue.labels.*.name, 'epic')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create sub-issues for Epic
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context;
            const parentNumber = issue.number;
            const parentTitle = issue.title;
            const subtasks = [
              "Requirements Analysis",
              "Design and Architecture",
              "Implementation",
              "Testing and Documentation"
            ];

            // Create 4 sub-issues
            const createdSubtasks = [];
            for (let i = 0; i < subtasks.length; i++) {
              const taskIndex = i + 1;
              const subtaskTitle = `[SUBTASK] ${parentTitle} - Task ${taskIndex}: ${subtasks[i]}`;
              const subtaskBody = `Related to #${parentNumber}\n\nThis is a subtask of the epic issue #${parentNumber}.`;

              const subtask = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: subtaskTitle,
                body: subtaskBody,
                labels: ["enhancement", "needs-review"]
              });

              createdSubtasks.push(subtask.data);
            }

            // Update parent issue with Epic Tasks checklist
            const checklistItems = createdSubtasks.map((subtask, index) => {
              const taskIndex = index + 1;
              return `- [ ] Task ${taskIndex}: ${subtasks[index]} (#${subtask.number})`;
            }).join("\n");

            const updatedBody = (issue.body || "") + `\n\n## Epic Tasks\n${checklistItems}`;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentNumber,
              body: updatedBody
            });

  auto-response:
    runs-on: ubuntu-latest
    needs: issue-triage
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-response and status update
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context;
            const author = issue.user.login;
            const currentLabels = issue.labels.map(l => l.name);

            // Check if author is first-time contributor in this repo
            const authorIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: author,
              state: "all"
            });
            const isFirstTime = authorIssues.data.length === 1; // Only this issue exists

            // Add "first-time-contributor" label if applicable
            if (isFirstTime && !currentLabels.includes("first-time-contributor")) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ["first-time-contributor"]
              });
            }

            // Generate response based on issue category
            let responseContent = "";
            if (currentLabels.includes("bug")) {
              responseContent = `### Bug Report Guidelines\n\nThank you for reporting this bug! Please ensure you've provided all necessary details (steps to reproduce, expected behavior, environment info) as outlined in the [Bug Report Template](/.github/ISSUE_TEMPLATE/bug_report.md).\n\nIf you need assistance, mention a repository maintainer.`;
            } else if (currentLabels.includes("epic")) {
              responseContent = `### Feature Request Process\n\nThank you for submitting this Epic feature request! We've automatically created 4 subtasks to break down this work (see the checklist below).\n\nPlease review the [Feature Request Template](/.github/ISSUE_TEMPLATE/feature_request.md) for more details on our feature process.`;
            } else if (currentLabels.includes("maintenance")) {
              responseContent = `### Maintenance Guidelines\n\nThank you for submitting this maintenance task! Please ensure you've provided details on impact, timeline, and dependencies as outlined in the [Maintenance Report Template](/.github/ISSUE_TEMPLATE/maintenance_report.md).\n\nA maintainer will review this task shortly.`;
            }

            // Add welcome message for first-time contributors
            if (isFirstTime) {
              responseContent = `Welcome to the repository, @${author}! This is your first issue here - thank you for contributing!\n\n${responseContent}`;
            }

            // Post response comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: responseContent
            });

            // Set milestone for high/critical priority issues
            if (currentLabels.includes("priority-high") || currentLabels.includes("priority-critical")) {
              // Check if "v1.0.0" milestone exists, create if missing
              let milestone = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "all"
              }).then(res => res.data.find(m => m.title === "v1.0.0"));

              if (!milestone) {
                milestone = await github.rest.issues.createMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: "v1.0.0"
                }).then(res => res.data);
              }

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: milestone.number
              });
            }

            // Update status from "needs-triage" to "needs-review"
            if (currentLabels.includes("needs-triage")) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: "needs-triage"
              });

              if (!currentLabels.includes("needs-review")) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ["needs-review"]
                });
              }
            }